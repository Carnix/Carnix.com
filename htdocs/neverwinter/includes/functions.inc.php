<?php	define("INACTIVE_DAYS", 30);	define("REQUIRE_ACCESS_KEY", TRUE);  	function getAccessKey($guild, $key, $db){    if(INACTIVE_DAYS === FALSE){ return true; }    else{      $conn = new mysqli($db['server'], $db['user'], $db['pass'], $db['name']);      if ($conn->connect_error) {          die("Connection failed: " . $conn->connect_error);      }      $sql = $conn->prepare('SELECT guild,access_key FROM access where guild = ?');      $sql->bind_param('s', $guild);      $sql->execute();      $result = $sql->get_result();      while ($row = $result->fetch_assoc()){        if($row['access_key'] === $key){          $conn->close();          return true;        }        else{          $conn->close();          return false;        }      }    }	}  	function getPopulationCount($flag, $group,  $db, $byguildcharacterflag = FALSE){ 		$output = 0;    $conn = new mysqli($db['server'], $db['user'], $db['pass'], $db['name']);		if ($conn->connect_error) { die("Connection failed: " . $conn->connect_error); }		if($flag != "characters" && $flag != "accounts"){      if($byguildcharacterflag === FALSE){        $sql = "SELECT COUNT(DISTINCT account_handle) AS Count FROM guild_".$flag;        $result = $conn->query($sql);        while($row = $result->fetch_assoc()){ $output = $row["Count"]; }      }      else{        $sql = "SELECT COUNT(character_name) AS Count FROM guild_".$flag;        $result = $conn->query($sql);        while($row = $result->fetch_assoc()){ $output = $row["Count"]; }      }		}		elseif($flag == "characters"){			$sql = "SELECT association_list FROM associations WHERE association_name = '".$group."'";			$result = $conn->query($sql);			while($row = $result->fetch_assoc()){ $association_list = $row['association_list']; }      $associationArray = explode(',', $association_list);      foreach ($associationArray as $guildname) {        $sql = "SELECT COUNT(character_name) as Count FROM guild_".$guildname;        $result = $conn->query($sql);  			while($row = $result->fetch_assoc()){ $member_count = ($row["Count"] * 1); }        $output += $member_count;      }		}		elseif($flag == "accounts"){      //@TODO:  Remove the guild names from this query.      $sql = "SELECT count(DISTINCT account_handle) AS Count FROM (SELECT  account_handle FROM guild_greycloaks UNION SELECT  account_handle FROM guild_blackcloaks UNION SELECT  account_handle FROM guild_whitecloaks UNION SELECT  account_handle FROM guild_browncloaks UNION SELECT  account_handle FROM guild_goldcloaks) AS SubQueryAlias";      $result = $conn->query($sql);      while($row = $result->fetch_assoc()){        $output = ($row["Count"] * 1);      }		}    		$conn->close();		return $output;	}	function update_database($csv, $guild, $db){    		set_time_limit(90);    $conn = new mysqli($db['server'], $db['user'], $db['pass'], $db['name']);		    if ($conn->connect_error) {		    die("Connection failed: " . $conn->connect_error);		}    $guild_key = strtolower(str_replace(" ", "_", $guild));		foreach($csv as $member){			$character = $member[0];			$handle = $member[1];      $level = $member[2];      $rank_name = $member[4];      $contributions = $member[5];      $date_joined = date("Y-m-d H:i:s", strtotime($member[6]));      $date_promoted = date("Y-m-d H:i:s", strtotime($member[7]));      $date_last_seen = date("Y-m-d H:i:s", strtotime($member[8]));			$character_name_full = $character.$handle;      $current_guild = $guild;     			$sql = 'INSERT INTO guild_' . $guild_key . ' (character_full_name, character_name, account_handle, level, guild_rank, contribution, guild, join_date, rank_change_date, last_active_date, created, updated)					VALUES	(            "'.$character_name_full.'",						"'.$character.'",						"'.$handle.'",						"'.$level.'",						"'.$rank_name.'",						"'.$contributions.'",            "'.$current_guild.'",						"'.$date_joined.'",						"'.$date_promoted.'",						"'.$date_last_seen.'",            "'.date("Y-m-d H:i:s").'",            "'.date("Y-m-d H:i:s").'"					)					ON DUPLICATE KEY UPDATE						join_date="'.$date_joined.'",						last_active_date="'.$date_last_seen.'",						guild_rank="'.$rank_name.'",            rank_change_date = "'.$date_promoted.'",            level = "'.$level.'",            updated = "'.date("Y-m-d H:i:s").'",            guild = "'.$current_guild.'"			';      if ($conn->query($sql) === TRUE){}else{}    }		$conn->close();		return TRUE;  }   	function getPopulationData($db){    $output = array();		$output['current'] = array(			"total" => getPopulationCount("characters", 'Cloaks', $db),			"accounts" => getPopulationCount("accounts", 'Cloaks', $db),			"greycloaks" => getPopulationCount("greycloaks", 'Cloaks', $db),			"whitecloaks" => getPopulationCount("whitecloaks", 'Cloaks', $db),			"goldcloaks" => getPopulationCount("goldcloaks", 'Cloaks', $db),			"browncloaks" => getPopulationCount("browncloaks", 'Cloaks', $db),			"blackcloaks" => getPopulationCount("blackcloaks", 'Cloaks', $db)		);    return $output;  }      //TODO:  this shit is off the chain.  Need to break it into logical units.  function updateTrends($db,$association){    $conn = new mysqli($db['server'], $db['user'], $db['pass'], $db['name']);    if ($conn->connect_error) {		    die("Connection failed: " . $conn->connect_error);		}    $trends_table = 'trends_'.$association . "_";        //first - get all the guilds for a given association    $sql = $conn->prepare('SELECT association_list, association_name FROM associations WHERE association_key = ?');    $sql->bind_param('s', $association);    $sql->execute();    $result = $sql->get_result();    $association_list = "";    $association_name = "";    while ($row = $result->fetch_assoc()){      $association_list = $row['association_list'];      $association_name = $row['association_name'];    }    $guildList = str_getcsv($association_list);    $total_accounts = 0;    $total_characters = 0;    $sql = $conn->prepare('SELECT COUNT(DISTINCT account_handle) As Count FROM guild__' . $association);    $sql->execute();    $result = $sql->get_result();    while ($row = $result->fetch_assoc()){      $total_accounts = $row['Count'];    }       $sql = $conn->prepare('SELECT COUNT(character_name) As Count FROM guild__' . $association);    $sql->execute();    $result = $sql->get_result();    while ($row = $result->fetch_assoc()){      $total_characters = $row['Count'];    }        $sql = 'TRUNCATE TABLE guild__'.$association;    $result = $conn->query($sql);        $sql = 'INSERT INTO guild__'.$association.' (character_name, account_handle, guild)'            . ' SELECT character_name, account_handle, guild FROM (';    $i = 0;    foreach($guildList as $guild_name){      if($i === 0){ $sql .= ' SELECT character_name, account_handle, guild FROM guild_' . $guild_name; }      else{ $sql .= ' UNION SELECT character_name, account_handle, guild FROM guild_' . $guild_name; }      $i++;    }    $sql .= ') AS SubQueryAlias';    $result = $conn->query($sql);    foreach($guildList as $guild_name){      $accounts = 0;      $characters = 0;      $accounts_prev = 0;      $characters_prev = 0;      $guild_table = 'guild_'.$guild_name;      $accounts = getPopulationCount($guild_name, $association_name, $db);      $characters = getPopulationCount($guild_name, $association_name, $db, TRUE);            $sql = $conn->prepare('SELECT accounts, characters FROM ' . $trends_table.$guild_name);      $sql->execute();      $result = $sql->get_result();            while ($row = $result->fetch_assoc()){        $accounts_prev = $row['accounts'];        $characters_prev = $row['characters'];      }        $accounts_delta = $accounts - $accounts_prev;      $characters_delta = $characters - $characters_prev;      $sql = 'INSERT INTO ' . $trends_table . $guild_name .' (accounts, characters, accounts_delta, characters_delta, date)          VALUES	(            "'.$accounts.'",            "'.$characters.'",            "'.$accounts_delta.'",            "'.$characters_delta.'",            "'.date("Y-m-d").'"      )';      if ($conn->query($sql) === TRUE){}else{}    }    $accounts_prev = 0;    $characters_prev = 0;    $sql = $conn->prepare('SELECT COUNT(DISTINCT account_handle) As Count FROM guild__' . $association);    $sql->execute();    $result = $sql->get_result();    while ($row = $result->fetch_assoc()){      $accounts_prev = $row['Count'];    }       $sql = $conn->prepare('SELECT COUNT(character_name) As Count FROM guild__' . $association);    $sql->execute();    $result = $sql->get_result();    while ($row = $result->fetch_assoc()){      $characters_prev = $row['Count'];    }           $accounts_delta = $total_accounts - $accounts_prev;    $characters_delta = $total_characters - $characters_prev;    $sql = 'INSERT INTO ' . $trends_table . ' (accounts, characters, accounts_delta, characters_delta, date)        VALUES	(          "'.$total_accounts.'",          "'.$total_characters.'",          "'.$accounts_delta.'",          "'.$characters_delta.'",          "'.date("Y-m-d").'"    )';    if ($conn->query($sql) === TRUE){}else{}        $conn->close();      }  ?>